#include "MsgRepoPatch.h"

inline void ReplaceStringW(const PDATA (&pBlockStart)[5], const char* StrMatch, const wchar_t* wStrReplace)
{
    const char* MsgBlock = TraversePtr(pBlockStart);
    const uint32_t BlockSize = *reinterpret_cast<const uint32_t*>(MsgBlock + 4);

    const size_t StrLen = (wcslen(wStrReplace) + 1) * 2;

    const char* StrMask = "........................";
    const auto pattern = mem::pattern(StrMatch, StrMask);
    const auto region = mem::region(MsgBlock, BlockSize);
    wchar_t* str = mem::simd_scanner(pattern).scan(region).any();

    if (str != nullptr)
    {
        wcsncpy_s(str, StrLen, wStrReplace, StrLen);
    }
    else
    {
        AllocConsoleOnce();
        std::wcout << L"String replacement target for" << wStrReplace << L" not found.\n";
    }
}

extern void PatchMsgRepo()
{
    if (*CSLang == 8)
    {
        const char StrMatch1[] = { 0x52, 0x0, 0x65, 0x0, 0x73, 0x0, 0x65, 0x0, 0x74, 0x0, 0x20, 0x0, 0x63, 0x0, 0x61, 0x0, 0x6D, 0x0, 0x65, 0x0, 0x72, 0x0, 0x61, 0x0 };
        ReplaceStringW(MsgRepo1Ptr, StrMatch1, L"Track dodges");

        const char StrMatch2[] = { 0x43, 0x0, 0x61, 0x0, 0x6D, 0x0, 0x65, 0x0, 0x72, 0x0, 0x61, 0x0, 0x20, 0x0, 0x73, 0x0, 0x70, 0x0, 0x65, 0x0, 0x65, 0x0, 0x64, 0x0 };
        ReplaceStringW(MsgRepo1Ptr, StrMatch2, L"FOV");

        const char StrMatch3[] = { 0x53, 0x0, 0x65, 0x0, 0x74, 0x0, 0x20, 0x0, 0x63, 0x0, 0x61, 0x0, 0x6D, 0x0, 0x65, 0x0, 0x72, 0x0, 0x61, 0x0, 0x20, 0x0, 0x6D, 0x0 };
        ReplaceStringW(MsgRepo2Ptr, StrMatch3, L"Set camera field of view.");

        const char StrMatch4[] = { 0x43, 0x0, 0x61, 0x0, 0x6D, 0x0, 0x65, 0x0, 0x72, 0x0, 0x61, 0x0, 0x20, 0x0, 0x72, 0x0, 0x65, 0x0, 0x73, 0x0, 0x65, 0x0, 0x74, 0x0 };
        ReplaceStringW(MsgRepo2Ptr, StrMatch4, L"Configure head tracking for dodges.");

        const char StrMatch5[] = { 0x4D, 0x0, 0x6F, 0x0, 0x75, 0x0, 0x73, 0x0, 0x65, 0x0, 0x20, 0x0, 0x73, 0x0, 0x65, 0x0, 0x6E, 0x0, 0x73, 0x0, 0x69, 0x0, 0x74, 0x0 };
        ReplaceStringW(MsgRepo3Ptr, StrMatch5, L"Sensitivity");

        const char StrMatch6[] = { 0x53, 0x0, 0x65, 0x0, 0x74, 0x0, 0x20, 0x0, 0x6D, 0x0, 0x6F, 0x0, 0x75, 0x0, 0x73, 0x0, 0x65, 0x0, 0x20, 0x0, 0x73, 0x0, 0x65, 0x0 };
        ReplaceStringW(MsgRepo3Ptr, StrMatch6, L"Set sensitivity for camera movement.");
    }
    else
    {
        AllocConsoleOnce();
        std::cout << "Game language is not set to English.\nReverting to default settings layout.\n";
    }
}